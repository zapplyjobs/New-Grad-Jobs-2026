name: Update Zapply Jobs

on:
  schedule:
    # Run every 12 minutes (staggered schedule: 0, 12, 24, 36, 48)
    - cron: '0,12,24,36,48 * * * *'
  workflow_dispatch: # Allow manual triggering
    inputs:
      debug_mode:
        description: 'Enable pipeline tracing for debugging (creates debug-trace.json)'
        required: false
        type: boolean
        default: false
  push:
    branches: [ main ]
    paths:
      - '.github/scripts/job-fetcher/**'
      - '.github/scripts/unified-job-fetcher.js'
      - 'jobboard/src/backend/**'

# Prevent concurrent runs to avoid git conflicts
concurrency:
  group: job-updates-${{ github.repository }}
  cancel-in-progress: false  # Don't cancel, wait for previous to finish

jobs:
  update-jobs:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Increased from 15 to prevent stuck runs
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ github.ref_name }}  # Use the branch that triggered the workflow
        fetch-depth: 1  # Shallow clone (faster checkout, 6-8 min -> 30 sec)
        token: ${{ secrets.GITHUB_TOKEN }}  # Use default token for pushing
        submodules: recursive  # Initialize git submodules (required for shared/ directory)

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: |
          package-lock.json
          jobboard/package-lock.json


    - name: Install job fetcher dependencies
      run: npm install axios

    - name: Install jobboard dependencies
      run: |
        cd jobboard
        npm install --production --no-audit --no-fund
        cd ..

    - name: Update job listings
      run: node .github/scripts/job-fetcher/index.js 2>&1 | tee .github/logs/job-fetcher.log
      env:
        PRIMARY_DATA_SOURCE_URL: ${{ secrets.JOB_PROCESSOR_URL }}
        ENABLE_MARKDOWN_CONVERSION: true  # Feature flag: Set to 'true' to enable HTML-to-Markdown conversion
        # Feature flag: Use JSearch API (90 jobs/day quota)
        # Set to 'true' to enable JSearch API fetches alongside ATS sources
        USE_JSEARCH: ${{ secrets.USE_JSEARCH || 'true' }}
        JSEARCH_API_KEY: ${{ secrets.JSEARCH_API_KEY }}
        # Debug mode: Enable pipeline tracing (zero overhead when false)
        DEBUG_MODE: ${{ github.event.inputs.debug_mode || 'false' }}

    - name: Display public status
      run: |
        echo "âœ… Job collection completed"
        if [ -f "README.md" ]; then
          JOB_COUNT=$(grep -o "Total_Jobs-[0-9]*-" README.md | grep -o "[0-9]*" || echo "0")
          echo "ðŸ“Š Total positions: $JOB_COUNT"
        fi

    - name: Export jobs to encrypted JSON (for external job boards)
      run: node .github/scripts/jobs-data-exporter.js
      env:
        LOG_ENCRYPT_PASSWORD: ${{ secrets.LOG_ENCRYPT_PASSWORD }}

    # NOTE: current_jobs.json is already written by job-processor.js
    # write-current-jobs.js was removed because it overwrote fresh data with stale posted_jobs.json
    # See: Architecture change Feb 10 - individual repos no longer maintain posted_jobs.json

    - name: Generate metrics report
      if: always()
      run: node .github/scripts/generate-metrics-report.js --days=7
      env:
        LOG_ENCRYPT_PASSWORD: ${{ secrets.LOG_ENCRYPT_PASSWORD }}

    - name: Generate workflow metrics
      if: always()
      run: node .github/scripts/output-metrics.js

    - name: Generate debug dashboard
      if: always()
      run: node scripts/generate-debug-dashboard.js

    - name: Upload debug trace (if debug mode enabled)
      if: github.event.inputs.debug_mode == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: pipeline-trace-${{ github.run_id }}
        path: .github/data/debug-trace.json
        retention-days: 7

    - name: Display trace summary (if debug mode enabled)
      if: github.event.inputs.debug_mode == 'true'
      run: |
        echo "ðŸ“Š Pipeline Trace Summary:"
        echo "=========================="
        if [ -f ".github/data/debug-trace.json" ]; then
          echo "âœ… Debug trace created successfully"
          echo ""
          echo "Checkpoints:"
          cat .github/data/debug-trace.json | jq -r '.checkpoints[] | "  \(.stage): \(.counts.total) jobs"'
          echo ""
          echo "ðŸ“„ Download full trace from Artifacts section above"
          echo "ðŸ’¡ Analyze with: node scripts/analyze-debug-trace.js debug-trace.json"
        else
          echo "âš ï¸  Debug trace file not found (DEBUG_MODE may not be set correctly)"
        fi

    - name: Verify file modifications (debug git staging bug)
      run: |
        echo "ðŸ” Verifying current_jobs.json was actually modified..."
        echo ""

        # Get disk file info
        if [ -f ".github/data/current_jobs.json" ]; then
          DISK_SIZE=$(stat -c%s .github/data/current_jobs.json 2>/dev/null || stat -f%z .github/data/current_jobs.json 2>/dev/null)
          DISK_HASH=$(sha256sum .github/data/current_jobs.json | awk '{print $1}')
          echo "ðŸ“ Disk file: $DISK_SIZE bytes, hash: ${DISK_HASH:0:16}..."
        else
          echo "âŒ ERROR: current_jobs.json not found on disk!"
          exit 1
        fi

        # Get git HEAD version hash
        if git cat-file -e HEAD:.github/data/current_jobs.json 2>/dev/null; then
          GIT_HASH=$(git show HEAD:.github/data/current_jobs.json | sha256sum | awk '{print $1}')
          echo "ðŸ“¦ Git HEAD: hash: ${GIT_HASH:0:16}..."
        else
          echo "âš ï¸  File doesn't exist in git HEAD (new file)"
          GIT_HASH=""
        fi

        # Compare
        if [ -n "$GIT_HASH" ] && [ "$DISK_HASH" = "$GIT_HASH" ]; then
          echo ""
          echo "âš ï¸  WARNING: Disk file is IDENTICAL to git HEAD!"
          echo "This means job-processor did NOT actually modify the file."
          echo "File was not updated despite 'Saved X jobs' log message."
          echo ""
          echo "ðŸ” This indicates:"
          echo "  - Job-processor claimed to save jobs but file unchanged"
          echo "  - OR something reset the file after job-processor ran"
          echo "  - OR TTL filtering removed exactly as many jobs as were added (equilibrium)"
          echo ""
        else
          echo ""
          echo "âœ… File was modified (disk != git HEAD)"
          echo "Git should recognize this as a change."
        fi

    - name: Check for changes
      id: verify-changed-files
      run: |
        echo "ðŸ“‹ Git status:"
        git status --porcelain
        echo ""
        echo "ðŸ“Š Posted jobs file info:"
        ls -lh .github/data/posted_jobs.json || echo "File not found!"
        echo "Last modified: $(stat -c '%y' .github/data/posted_jobs.json 2>/dev/null || stat -f '%Sm' .github/data/posted_jobs.json 2>/dev/null || echo 'unknown')"
        echo ""

        if [ -n "$(git status --porcelain)" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "âœ… Found changes in files"
        else
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "âš ï¸  No changes detected"
        fi

    - name: Commit and Push changes
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"

        # Function to commit and push with proper conflict resolution
        commit_and_push() {
          local max_attempts=5
          local delay=5

          for attempt in $(seq 1 $max_attempts); do
            echo "========================================="
            echo "Attempt $attempt of $max_attempts"
            echo "========================================="

            # STEP 1: Force git to refresh index (fix for staging bug)
            echo "ðŸ”§ Refreshing git index to recognize file changes..."
            # Force git to re-stat files and update the index
            git update-index --refresh 2>/dev/null || true

            # STEP 2: Stage fresh data files BEFORE pulling (prevents data loss)
            echo "ðŸ“¦ Staging fresh data files..."
            # Use explicit file paths to ensure they're added
            git add --force -- \
                    .github/data/new_jobs.json \
                    .github/data/posted_jobs.json \
                    .github/data/current_jobs.json \
                    .github/data/seen_jobs.json \
                    .github/data/pending_posts.json \
                    .github/data/jsearch_usage.json \
                    .github/data/jobs-data-encrypted.json \
                    .github/data/workflow_metrics.json \
                    .github/data/debug-dashboard.json \
                    .github/data/metrics/latest.json \
                    .github/data/metrics/*.json \
                    .github/audit/latest.md \
                    .github/audit/routing-encrypted.json \
                    README.md 2>/dev/null || true

            # STEP 3: Verify staging worked
            echo "ðŸ” Verifying files were staged..."
            # Show what was staged
            echo "âœ… Files successfully staged:"
            git diff --staged --stat || echo "  (stat failed, but files were added)"

            # STEP 4: Create temporary commit to protect fresh data
            echo "ðŸ’¾ Creating temporary commit to protect fresh data..."
            TEMP_MSG="temp: preserve fresh data from $(date +'%Y-%m-%d %H:%M UTC')"
            if ! git commit -m "$TEMP_MSG"; then
              echo "âš ï¸  Commit failed, may already be committed"
            fi

            # STEP 5: Pull with rebase (preserves our commit on top of remote)
            echo "â¬‡ï¸  Pulling latest changes from remote..."
            if ! git pull --rebase origin ${{ github.ref_name }}; then
              echo "âš ï¸  Pull had conflicts, resolving by keeping our data files..."
              # Keep our versions for all data files (our fresh data wins)
              git checkout --ours .github/data/*.json 2>/dev/null || true
              git checkout --ours .github/data/metrics/*.json 2>/dev/null || true
              git checkout --ours .github/audit/*.md 2>/dev/null || true
              git checkout --ours README.md 2>/dev/null || true
              git add -u
              git rebase --continue || echo "Rebase completed with conflict resolution"
            fi

            # STEP 6: Amend commit with proper message
            echo "ðŸ“ Updating commit message..."
            JOB_COUNT=$(grep -o "Total_Jobs-[0-9]*-" README.md | grep -o "[0-9]*" || echo "0")
            COMPANY_COUNT=$(grep -o "Companies-[0-9]*-" README.md | grep -o "[0-9]*" || echo "0")

            COMMIT_MSG="Update jobs - $(date +'%Y-%m-%d %H:%M UTC')

        Found $JOB_COUNT positions from $COMPANY_COUNT companies
        Updated categories, locations, and experience levels"

            git commit --amend -m "$COMMIT_MSG" || echo "Commit message updated"

            # STEP 7: Push with retry
            echo "â¬†ï¸  Pushing changes to remote..."
            if git push origin ${{ github.ref_name }}; then
              echo "âœ… Successfully pushed changes!"
              exit 0
            else
              echo "âŒ Push failed (branch diverged again)"

              # Undo commit but keep changes staged for retry
              git reset --soft HEAD~1

              # Exponential backoff
              echo "â³ Waiting ${delay}s before retry..."
              sleep $delay
              delay=$((delay * 2))
            fi
          done

          echo "========================================="
          echo "âŒ Failed to push after $max_attempts attempts"
          echo "========================================="
          exit 1
        }

        # Execute the function
        commit_and_push

    - name: Create job summary
      run: |
        echo "## ðŸš€ Zapply Jobs Updated!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ steps.verify-changed-files.outputs.changed }}" == "true" ]; then
          # Extract stats from README
          JOB_COUNT=$(grep -o "Total_Jobs-[0-9]*-" README.md | grep -o "[0-9]*" || echo "0")
          COMPANY_COUNT=$(grep -o "Companies-[0-9]*-" README.md | grep -o "[0-9]*" || echo "0")
          # Note: FAANG badge may not exist in current format, default to 0
          FAANG_COUNT=$(grep -o "FAANG.*-[0-9]*-" README.md | grep -o "[0-9]*" | head -1 || echo "0")

          echo "âœ… **Successfully updated job board with fresh opportunities**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Today's Haul:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ¯ **$JOB_COUNT total positions** from elite tech companies" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ¢ **$COMPANY_COUNT companies** tracked (FAANG, unicorns, startups)" >> $GITHUB_STEP_SUMMARY
          echo "- â­ **$FAANG_COUNT FAANG+ jobs** from top-tier companies" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Search Coverage:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŒ **Multi-location search**: SF Bay Area, NYC, Seattle, Austin, Remote" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ“ **All experience levels**: Entry-level to Senior positions" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ’¼ **10+ role categories**: SWE, ML/AI, Data, Mobile, DevOps, Product, Design" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ† **Elite companies only**: FAANG, unicorns, top startups, gaming leaders" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Quality Filters Applied:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ¨ Removed duplicates and spam postings" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ¢ Normalized company names and subsidiaries" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š Ranked by company tier (FAANG first)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”— Verified direct application links" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ”„ Next update**: In ~15 minutes" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ“¥ Detailed logs**: Download artifacts (collaborators only)" >> $GITHUB_STEP_SUMMARY
        else
          echo "â„¹ï¸ **No new opportunities found - job board is current**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All tracked companies have been checked for new postings." >> $GITHUB_STEP_SUMMARY
          echo "The existing job listings are still fresh and active." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ”„ Next check**: In ~15 minutes" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ“¥ Detailed logs**: Download artifacts (collaborators only)" >> $GITHUB_STEP_SUMMARY
        fi
