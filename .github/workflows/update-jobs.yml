name: Update Jobs from Aggregator

on:
  schedule:
    - cron: '0,12,24,36,48 * * * *'  # Every 12 minutes (staggered schedule)
  workflow_dispatch: # Allow manual triggering
  push:
    branches: [ main ]
    paths:
      - '.github/scripts/job-fetcher/**'
      - '.github/scripts/write-current-jobs.js'

# Prevent concurrent runs to avoid git conflicts
concurrency:
  group: job-updates-${{ github.repository }}
  cancel-in-progress: false

jobs:
  update-jobs:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ github.ref_name }}
        fetch-depth: 1
        submodules: recursive
        token: ${{ secrets.GH_PAT }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies
      run: npm install axios

    - name: Fetch and update jobs
      run: |
        mkdir -p .github/logs
        node .github/scripts/job-fetcher/index.js 2>&1 | tee .github/logs/job-fetcher.log

    - name: Write current_jobs.json for aggregator
      run: |
        mkdir -p .github/data
        node .github/scripts/write-current-jobs.js

    - name: Display job-fetcher logs (always run)
      if: always()
      run: |
        echo "Job Fetcher Output (last 100 lines):"
        tail -100 .github/logs/job-fetcher.log || echo "Log file not found"

    - name: Display public status
      run: |
        echo "Job collection completed"

