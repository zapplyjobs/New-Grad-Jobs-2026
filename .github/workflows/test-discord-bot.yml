name: Test Discord Bot

on:
  pull_request:
    paths:
      - '.github/scripts/**'
      - '.github/workflows/test-discord-bot.yml'
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies
      run: |
        npm install discord.js axios

    - name: Syntax validation
      run: |
        echo "=== Validating JavaScript syntax ==="
        node --check .github/scripts/enhanced-discord-bot.js
        node --check .github/scripts/src/discord/config.js
        node --check .github/scripts/src/routing/router.js
        node --check .github/scripts/src/utils/job-normalizer.js
        node --check .github/scripts/src/utils/job-formatters.js
        node --check .github/scripts/src/data/posted-jobs-manager-v2.js
        node --check .github/scripts/src/data/subscription-manager.js
        echo "✅ All files passed syntax validation"

    - name: Test module imports
      run: |
        echo "=== Testing module imports ==="
        node -e "
          const { CHANNEL_CONFIG } = require('./.github/scripts/src/discord/config');
          const { getJobChannelDetails } = require('./.github/scripts/src/routing/router');
          const { normalizeJob } = require('./.github/scripts/src/utils/job-normalizer');
          const { formatPostedDate } = require('./.github/scripts/src/utils/job-formatters');
          const PostedJobsManager = require('./.github/scripts/src/data/posted-jobs-manager-v2');
          const SubscriptionManager = require('./.github/scripts/src/data/subscription-manager');
          console.log('✅ All modules imported successfully');
        "

    - name: Test utility functions
      run: |
        echo "=== Testing utility functions ==="
        node -e "
          const { normalizeJob } = require('./.github/scripts/src/utils/job-normalizer');
          const { formatPostedDate, cleanJobDescription } = require('./.github/scripts/src/utils/job-formatters');

          // Test normalizeJob
          const testJob = {
            title: 'Software Engineer',
            company_name: 'Test Corp',
            url: 'https://example.com/job',
            locations: ['San Francisco, CA']
          };
          const normalized = normalizeJob(testJob);
          if (!normalized.job_title) throw new Error('normalizeJob failed');

          // Test formatPostedDate
          const formatted = formatPostedDate('2025-01-01');
          if (typeof formatted !== 'string') throw new Error('formatPostedDate failed');

          // Test cleanJobDescription
          const cleaned = cleanJobDescription('Test <script>alert(1)</script> description');
          if (cleaned.includes('script')) throw new Error('cleanJobDescription failed to sanitize');

          console.log('✅ All utility functions working correctly');
        "

    - name: Test results
      if: success()
      run: |
        echo "================================================"
        echo "✅ ALL TESTS PASSED"
        echo "================================================"
        echo "- Syntax validation: PASS"
        echo "- Module imports: PASS"
        echo "- Utility functions: PASS"
        echo "================================================"
