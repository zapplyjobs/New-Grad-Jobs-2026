name: Daily Health Report

on:
  schedule:
    # Run daily at 9 AM UTC (1 AM PST / 4 AM EST)
    - cron: '0 9 * * *'
  workflow_dispatch: # Allow manual triggering

permissions:
  issues: write # For creating/updating health report issues
  contents: read

jobs:
  health-report:
    runs-on: ubuntu-latest
    name: Generate Workflow Health Report

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Run health report
        id: health-check
        run: |
          # Run health report and capture output
          node .github/scripts/workflow-health-report.js --last-24h > /tmp/health-output.txt 2>&1 || true

          # Display output
          cat /tmp/health-output.txt

          # Parse key metrics for step summary
          SUCCESS_RATE=$(grep -oP 'Success Rate: \K[\d.]+' /tmp/health-output.txt || echo "N/A")
          TOTAL_JOBS=$(grep -oP 'Total Jobs Processed: \K\d+' /tmp/health-output.txt || echo "N/A")
          V2_JOBS=$(grep -oP 'V2 Multi-Channel Posts: \K\d+' /tmp/health-output.txt || echo "N/A")
          FAILURES=$(grep -oP 'Zero Channels \(Failures\): \K\d+' /tmp/health-output.txt || echo "N/A")

          # Write to GitHub Step Summary
          echo "## ðŸ“Š GitHub Discord Health Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Report Date:** $(date -u +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Status badge
          if (( $(echo "$SUCCESS_RATE >= 90" | bc -l 2>/dev/null || echo 0) )); then
            echo "### âœ… Status: HEALTHY" >> $GITHUB_STEP_SUMMARY
          elif (( $(echo "$SUCCESS_RATE >= 70" | bc -l 2>/dev/null || echo 0) )); then
            echo "### âš ï¸ Status: WARNING" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ðŸ”´ Status: CRITICAL" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Key Metrics (Last 24 Hours)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Success Rate** | ${SUCCESS_RATE}% |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total Jobs** | ${TOTAL_JOBS} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Posted Successfully** | ${V2_JOBS} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Failures** | ${FAILURES} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Add trend indicator
          echo "### ðŸ“ˆ Trend" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if (( $(echo "$SUCCESS_RATE >= 95" | bc -l 2>/dev/null || echo 0) )); then
            echo "ðŸŸ¢ Excellent - System performing optimally" >> $GITHUB_STEP_SUMMARY
          elif (( $(echo "$SUCCESS_RATE >= 90" | bc -l 2>/dev/null || echo 0) )); then
            echo "ðŸŸ¡ Good - Minor issues detected" >> $GITHUB_STEP_SUMMARY
          elif (( $(echo "$SUCCESS_RATE >= 70" | bc -l 2>/dev/null || echo 0) )); then
            echo "ðŸŸ  Warning - Investigation recommended" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸ”´ Critical - Immediate action required" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“„ **Full Report:** See workflow logs above" >> $GITHUB_STEP_SUMMARY

      - name: Upload health report artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: health-report-${{ github.run_number }}
          path: .github/data/health-report.json
          retention-days: 30

      - name: Create/Update Health Issue
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const reportPath = '.github/data/health-report.json';

            if (!fs.existsSync(reportPath)) {
              console.log('Health report file not found, skipping issue creation');
              return;
            }

            const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));

            const issueTitle = 'ðŸš¨ CRITICAL: Workflow Health Below 70%';
            const issueBody = `
            # ðŸ“Š Workflow Health Report - CRITICAL

            **Generated:** ${report.timestamp}
            **Status:** ðŸ”´ CRITICAL (${report.postingRate}% success rate)

            ## Summary

            - **Total Jobs:** ${report.totalJobs}
            - **Posted Successfully:** ${report.postedJobs} (${report.postingRate}%)
            - **Not Posted:** ${report.unpostedJobs} (${(100 - report.postingRate).toFixed(2)}%)

            ## Breakdown

            - V2 Multi-Channel Posts: ${report.jobsWithDiscordPosts}
            - V1 Legacy Posts: ${report.jobsWithLegacyPost}
            - âŒ Zero Channels (BUG): ${report.jobsWithZeroChannels}
            - Never Processed: ${report.jobsNeverProcessed}

            ## Top Affected Companies

            ${Object.entries(report.companiesAffected || {})
              .sort(([, a], [, b]) => b - a)
              .slice(0, 10)
              .map(([company, count]) => `- ${company}: ${count} jobs`)
              .join('\n')}

            ## Sample Failed Jobs

            ${report.unpostedJobsSample.map((job, idx) =>
              `${idx + 1}. **${job.company}** - ${job.title}\n   - Location: ${job.city}, ${job.state}\n   - Date: ${job.datePosted}`
            ).join('\n')}

            ---

            **Action Required:** Investigate why ${report.jobsWithZeroChannels} jobs have empty \`discordPosts\` objects.

            **View full report:** [Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'health-report,critical'
            });

            const existingIssue = issues.data.find(issue => issue.title === issueTitle);

            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: issueBody
              });
              console.log(`Updated existing issue #${existingIssue.number}`);
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: ['health-report', 'critical', 'bug']
              });
              console.log('Created new critical health issue');
            }

      - name: Notify via Workflow Summary
        if: always()
        run: |
          echo "âœ… Health report completed. Check the step summary above for details."
